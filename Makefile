export PATH := /opt/gcc-4.8.1/bin:$(PATH)

# generate config file
$(shell ./build_deps.sh build_config.mk)
# this file is generated by the previous line to set build flags
include build_config.mk

OPT += -g -O2 -DNDEBUG
OPT += -Wall -Werror -Wsign-compare
export CGO_CFLAGS=$(OPT) -I$(ROCKSDB)/include
export CGO_LDFLAGS=-L$(ROCKSDB)

GO_FLAGS  = --ldflags '-extldflags "-static-libstdc++"'
#GO_FLAGS = --ldflags '-extldflags "-static-libstdc++ -static-libgcc"'
#GO_FLAGS = -v -x --ldflags '-extldflags "-static"'

all: build rocksdb-clean

build: rocksdb-lib go-deps
	go install $(GO_FLAGS) ./...

get: rocksdb-lib
	go get ./...

clean: rocksdb-clean
	go clean -i ./...

rocksdb-clean:
	rm build_config.mk
	rm -rf $(ROCKSDB)

rocksdb-lib:
	if [ ! -f "$(ROCKSDB)/librocksdb.a" ]; then \
		rm -rf $(ROCKSDB); \
		./build_deps.sh -dl; \
		make -C $(ROCKSDB) static_lib; \
	fi

go-deps:
	go get github.com/GeertJohan/go.linenoise
